
---
# CURRENT BUILD VERSION = 1.3.0
---
# docker-signservice

This repo contains build and deploy scripts for the SUNET electronic signature service. The following build and deployment steps should be followed:

1. Building a docker image
2. Setting up key files and configuration data.
3. Deploying the docker image as docker container.

The signservice application is provided as a signed war file which is deployed to the maven repo at: [https://maven.eidastest.se](https://maven.eidastest.se/artifactory/webapp/#/home)

## 1. Building docker file

The docker build script "build.sh" builds a docker image for the signature service by performing the following actions:

- Downloading the executable .war file from maven repository
- Downloading the signature (asc) on the metadata validator executable
- Verifying the signature on the downloaded .jar file.
- Building the Tomcat appication server with depedencies, scripts and installed web applications
- Building the docker image.

```
Usage: build.sh [options...]

   -u, --user             Username for Maven repository (default is eidasuser)
   -p, --passwd           Password for Maven repository (will be prompted for if not given)
   -v, --version          Version for artifact to download
   -i, --image            Name of image to create (default is cs-sigserver)
   -t, --tag              Optional docker tag for image
   -c, --clear            Clears the target directory after a successful build (default is to keep it)
   -h, --help             Prints this help
```

## 2. Configuration
The resources folder contains sample configuration data. The content of the `signservice` folder illustrates a working example file structure to be placed in a directory specified in a suitable location reflected in the settings of the environment variable `SIGNSERVICE_DATALOCATION`. This environment variable is set in the docker run command to define datastorage location inside the docker container.

The following folders and files are present in `signservice`:

Folder | Description
--- | ---
`CA` | Contains autogenerated CA instances issuing signer certificates
`conf`  |  Holds general configuration data for the sign service
`instances`  |  Configured instances of the signing service. Each instance may represent a unique organization this instance belongs to. All instances share the same CA but have unique SP keys and entityID for authentication and communication with requesting services
`keystores` | auto generated keystores holding RSA signer keys. These are pre-generated in order to provide faster signing process.
`publish`  | This forlder is used by the signing service to store published data such as Metadata and certificate revocation lists
`RootCA`  | Contains an autogenerated RootCA instance
`sigTasks`  |   Contains the database for storing sign request session data
`temp_keystores`  |  used by the system for temporary storage of signer keystores between the moment it is selected for a particular signer, until it is used and destroyed.

The following files are present in the conf directory:

File | Description
--- | ---
sig-config.json | Main configuration file
rootCaConf.json  | Configuration for the autogenerated RootCA instance
md-signer2.crt  | Certificate for verifying signatures on Metadata

### 2.1 Configuration settings
The `sig-config.json` file in the resources folder illustrates sensible defaults. However, the following values should be checked and assigned correct values:

Property | Value
--- | ---
`sigsp.config.mode`  |  mode options are "dev", "test" or "prod". Affecting visual appearance
`sigsp.config.title`  |  Title on all web pages. Note that åäöÅÄÖ must be specified as unicode characters. E.g "Bastj\u00E4nst f\u00F6r Elektronisk Underskrift"
`server.port`  |  Set the server port for the service. If TLS is used (port 8443) then the TLS settings must also be settings
`tomcat.ajp.enabled`  |  true or false dependeing on whether AJP should be exposed
`spring.servlet.multipart.max-file-size`  |  Sets the max file upload size. This value can be set to a maximum of 10 MB. Sizes larger than 10MB requires other measures to increase internal Spring Boot limitations.
`sigsp.config.signpage`  |  Sets properties related to the sign page
`signservice.pdf-signature-image.template`  |  Sets properties relatedto PDF sign image
`sigsp.federation.metadata` | Properties for downloading, validating and caching SAML metadta
`signservice.credential`  |  Properties for setting up the signing key for signing SignRequest to the signature service
`signservice.config.default-sign-requester-id`  |  The EntityID of this application expressed as the sign requesting service in requests to the signing service.
`signservice.config.sign-service-id`  |  The EntityID of the sign service  |
`signservice.config.default-destination-url` |  The URL where the Sign Request to the sign service is sent.


## 3. Running the docker container

The samples folder contains a sample docker deploy script `deploy.sh`:

```
#!/bin/bash

echo Deploying docker containter upload-sig-app
docker run -d --name upload-sig-app --restart=always \
  -p 8080:8080 -p 8009:8009 \
  -e "SPRING_CONFIG_ADDITIONAL_LOCATION=/opt/upload-sig-app/" \
  -v /etc/localtime:/etc/localtime:ro \
  -v /opt/docker/upload-sign-sp:/opt/upload-sig-app \
  upload-sign-sp

echo Done!
```

Use of http, https and ajp access to the service is specified in `application.properties`. The `Dockerfile` is reflecting this by currently exposing port 8080, 8443 and 8009.

The environment variable `SPRING_CONFIG_ADDITIONAL_LOCATION`, specifies the location where the configuration folder is located. Note that the specified location must end with a "/" character.

All property values in application.properties can be overridden by docker run environment variable settings. The convention is to specify the property name in uppercase letters and replace "." and "-" characters with underscore ("\_")

## 4. Shibboleth SP authentication

The current application requires a logged in user and depends on Shibboleth SP to provide user authetnication.
A sample shibboleth2.xml as well as a sample attribute-map.xml file is provided in the `shib-sp` folder in the `resources` folder.
